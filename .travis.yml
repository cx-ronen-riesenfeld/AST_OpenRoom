# This is a sample build configuration for Python.
# Check our guides at https://confluence.atlassian.com/x/x4UWN for more examples.
# Only use spaces to indent your .yml configuration.
# -----
# You can specify a custom docker image from Docker Hub as your build environment.
language: python
matrix:
.mixins:
- &xenial-mixin
  dist: xenial
  sudo: true
  addons:
    apt:
      packages:
        - libgnutls-dev
jobs:
  include:
    - python: 3.5
    - python: 3.6
    - python: pypy3.5-5.10.1
    - <<: *xenial-mixin
      python: 3.7
    - <<: *xenial-mixin
      python: nightly

install:
    # On nightly, upgrade setuptools first to work around
    # https://github.com/pypa/setuptools/issues/1257
    - if [[ $TRAVIS_PYTHON_VERSION == 'nightly' ]]; then travis_retry pip install -U setuptools; fi
    # TODO(bdarnell): pycares tests are currently disabled on travis due to ipv6 issues.
    #- if [[ $TRAVIS_PYTHON_VERSION != 'pypy'* ]]; then travis_retry pip install pycares; fi
    - if [[ $TRAVIS_PYTHON_VERSION != 'pypy'* ]]; then travis_retry pip install pycurl; fi
    # Twisted is flaky on pypy (TODO: still? this note is quite old)
    # It also sometimes has problems on nightly.
    - if [[ $TRAVIS_PYTHON_VERSION != 'pypy'* && $TRAVIS_PYTHON_VERSION != 'nightly' ]]; then travis_retry pip install Twisted; fi
    # Ideally we'd run the lint stuff on the latest Python
    # version supported. But Python 3.7 requires slower-to-start VMs,
    # so we run it on 3.6 to minimize total CI run time.
    - if [[ $TRAVIS_PYTHON_VERSION == '3.6' ]]; then travis_retry pip install flake8 mypy==0.630 black; fi
    # We run docs on py37 because we need some bug fixes for introspection of annotations.
    - if [[ $TRAVIS_PYTHON_VERSION == '3.7' ]]; then travis_retry pip install -r docs/requirements.txt; fi
    # On travis the extension should always be built
    - if [[ $TRAVIS_PYTHON_VERSION != 'pypy'* ]]; then export TORNADO_EXTENSION=1; fi
    - travis_retry python setup.py install
    - travis_retry pip install codecov virtualenv
    # Create a separate no-dependencies virtualenv to make sure all imports
    # of optional-dependencies are guarded.
    - virtualenv /tmp/nodeps
    - /tmp/nodeps/bin/python -VV
    - /tmp/nodeps/bin/python setup.py install
    - curl-config --version; pip freeze
 include:
  - name: "3.5 Static Analysis"
    env: TEST_SUITE=suite_3_5_unit
    script: python cx.py $Server $CxUsername $CxPassword $ClientSecret $ProjectName $TeamName $PresetName $FolderExclusions $FileExclusions https://bitbucket.org/$BITBUCKET_REPO_OWNER/$BITBUCKET_REPO_SLUG.git "master" $HighThreshold $MediumThreshold $LowThreshold            